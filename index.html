<!DOCTYPE html>
<html lang="it" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Il CamaLEOnte - Magazine Ufficiale</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>

    <style>
        /* BASE & RESET */
        * { -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { background-color: #121212; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        
        #zoom-wrapper { width: 960px; height: 680px; transition: transform 0.2s ease; transform-origin: center center; }
        #flipbook { width: 960px; height: 680px; opacity: 0; transition: opacity 1s; }
        #flipbook.visible { opacity: 1; }

        .page { background-color: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; }
        
        /* LAYERS (STRATI) PER EVITARE CONFLITTI */
        .layer-pdf { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .layer-interactive { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        /* I link devono avere pointer-events auto per essere cliccabili */
        .layer-interactive * { pointer-events: auto; }

        .pdf-canvas { width: 100%; height: 100%; display: block; }

        /* VIDEO */
        .magazine-video { 
            width: 100%; height: 100%; object-fit: cover; 
            position: absolute; top: 0; left: 0; z-index: 5; background: #000; 
        }

        /* --- STILE BOTTONI AZIONE (Home & Mode) --- */
        .action-btn {
            position: fixed; top: 20px; z-index: 9999; /* Z-index altissimo per stare sopra a tutto */
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(30,30,30,0.8); color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 24px; border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .action-btn:hover { background: #10b981; transform: scale(1.1); color: white; }
        .action-btn:active { transform: scale(0.95); }
        
        #mode-btn { left: 20px; }
        #home-btn { right: 20px; }

        /* --- LINK INDICE LUMINOSI --- */
        @keyframes aiPulse {
            0% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
            50% { background: rgba(52, 211, 153, 0.3); box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); border: 1px solid rgba(110, 231, 183, 0.8); }
            100% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
        }

        .index-link { 
            position: absolute; cursor: pointer; border-radius: 8px;
            animation: aiPulse 3s infinite ease-in-out; 
        }
        .index-link:hover {
            animation: none; 
            background: rgba(209, 250, 229, 0.5); 
            border: 2px solid #10b981;
            box-shadow: 0 0 25px #10b981; 
            transform: scale(1.02);
        }
    </style>
</head>
<body>

    <div id="mode-btn" class="action-btn" title="Cambia Vista">üìñ</div>
    <div id="home-btn" class="action-btn" title="Torna all'Indice">üè†</div>

    <div id="zoom-wrapper">
        <div id="flipbook"></div>
    </div>

    <script>
        (function() {
            // Rilevamento iniziale
            let isMobile = window.innerWidth < 768;
            let isSingleMode = isMobile; // Su mobile parte singolo, su desktop doppio
            
            const totalPages = 24; 
            const baseW = 960;
            const baseH = 680;

            const map = [
                { t: 20, l: 5,  w: 40, h: 8, p: 4 },  { t: 30, l: 5,  w: 40, h: 12, p: 5 }, 
                { t: 45, l: 5,  w: 40, h: 8, p: 6 },  { t: 58, l: 5,  w: 40, h: 8, p: 8 },  
                { t: 70, l: 5,  w: 40, h: 8, p: 10 }, { t: 82, l: 5,  w: 40, h: 8, p: 11 }, 
                { t: 20, l: 50, w: 40, h: 8, p: 12 }, { t: 30, l: 50, w: 40, h: 8, p: 13 }, 
                { t: 45, l: 50, w: 40, h: 8, p: 16 }, { t: 58, l: 50, w: 40, h: 8, p: 19 }, 
                { t: 70, l: 50, w: 40, h: 10, p: 21 },{ t: 82, l: 50, w: 40, h: 8, p: 22 }
            ];

            // RENDER PDF SICURO (Non cancella pi√π i link)
            async function renderPage(pageNum, container) {
                try {
                    const url = pageNum + '.pdf';
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    
                    // Scala alta per nitidezza
                    const viewport = page.getViewport({ scale: 2.5 }); 
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Pulisce SOLO il container del PDF, non tutta la pagina!
                    container.innerHTML = ''; 
                    container.appendChild(canvas);
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                } catch (e) { console.error(e); }
            }

            $(document).ready(function() {
                const fb = $('#flipbook');
                const wrapper = $('#zoom-wrapper');
                const modeBtn = $('#mode-btn');

                // 1. COSTRUZIONE PAGINE
                for (let i = 1; i <= totalPages; i++) {
                    const pg = $('<div class="page"></div>');
                    
                    // Creiamo DUE livelli separati
                    const pdfLayer = $('<div class="layer-pdf"></div>');
                    const interactiveLayer = $('<div class="layer-interactive"></div>');

                    pg.append(pdfLayer);
                    pg.append(interactiveLayer);

                    // Contenuto: Video o PDF
                    if (i === 23) {
                        pdfLayer.append(`<video class="magazine-video" playsinline webkit-playsinline><source src="23.mp4" type="video/mp4"></video>`);
                    } else {
                        // Carichiamo il PDF dentro il SUO layer specifico
                        renderPage(i, pdfLayer[0]);
                    }

                    // Pagina 3: Aggiunta Link nel livello interattivo (SOPRA il PDF)
                    if (i === 3) {
                        map.forEach((l) => {
                            const link = $('<div class="index-link"></div>').css({
                                top: l.t + '%', left: l.l + '%', width: l.w + '%', height: l.h + '%'
                            }).attr('data-target', l.p);
                            interactiveLayer.append(link);
                        });
                    }

                    fb.append(pg);
                }

                // 2. FUNZIONI DI RESIZE E MODALIT√Ä
                function updateLayout() {
                    // Aggiorna icona
                    modeBtn.text(isSingleMode ? 'üìÑ' : 'üìñ'); 

                    const winW = $(window).width();
                    const winH = $(window).height();

                    if (isSingleMode) {
                        // MODALIT√Ä LETTURA (Singola)
                        wrapper.css({ width: '100%', height: 'auto', transform: 'none' });
                        // Calcola dimensioni pagina singola
                        const pageW = winW;
                        const pageH = winW * 1.41; 
                        fb.turn('display', 'single');
                        fb.turn('size', pageW, pageH);
                    } else {
                        // MODALIT√Ä RIVISTA (Doppia)
                        // Calcola zoom per far stare tutto nello schermo
                        let scale = Math.min(winW / baseW, winH / baseH) * 0.95;
                        wrapper.css({ width: baseW, height: baseH, transform: `scale(${scale})` });
                        
                        fb.turn('display', 'double');
                        fb.turn('size', baseW, baseH);
                    }
                }

                // 3. INIZIALIZZAZIONE TURN.JS
                fb.turn({
                    width: baseW, height: baseH,
                    elevation: 50,
                    duration: 1000,
                    gradients: true,
                    autoCenter: true,
                    display: isSingleMode ? 'single' : 'double'
                });

                // 4. GESTIONE CLICK
                // Click sui link indice
                $(document).on('click', '.index-link', function() {
                    fb.turn('page', $(this).attr('data-target'));
                });

                // Click Home
                $('#home-btn').click(function() {
                    fb.turn('page', 3); // Vai all'indice
                });

                // Click Cambio Modalit√†
                modeBtn.click(function() {
                    isSingleMode = !isSingleMode;
                    updateLayout(); // Ricalcola tutto
                });

                // Resize Finestra
                $(window).resize(function() {
                    // Piccolo debounce per non sovraccaricare
                    clearTimeout(window.resizedFinished);
                    window.resizedFinished = setTimeout(updateLayout, 250);
                });

                // Avvio iniziale
                updateLayout();
                setTimeout(() => fb.addClass('visible'), 500);
            });
        })();
    </script>
</body>
</html>