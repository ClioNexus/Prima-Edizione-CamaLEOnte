<!DOCTYPE html>
<html lang="it" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Il CamaLEOnte - Magazine Ufficiale</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX'); 
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configura il worker per PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>

    <style>
        /* PROTEZIONI E RESET */
        * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { background-color: #121212; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        img { pointer-events: none; -webkit-user-drag: none; display: block; }

        #zoom-wrapper { width: 960px; height: 680px; transition: transform 0.1s linear; }
        #flipbook { width: 960px; height: 680px; opacity: 0; transition: opacity 1.2s; visibility: visible; }
        #flipbook.visible { opacity: 1; }

        .page { background-color: white; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.8); overflow: hidden; }
        
        /* Classe per il canvas del PDF */
        .pdf-canvas { 
            width: 100%; 
            height: 100%; 
            display: block; 
            pointer-events: none; /* Lascia passare i click ai link sopra */
        }

        .magazine-video { 
            width: 100%; height: 100%; object-fit: cover; 
            position: absolute; top: 0; left: 0; z-index: 10;
            background: #000; pointer-events: none;
        }

        /* --- ANIMAZIONE RESPIRO (FAMIGLIA VERDE) --- */
        @keyframes aiPulse {
            0% { 
                background: rgba(16, 185, 129, 0.05);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
                border: 1px solid rgba(16, 185, 129, 0.1);
            }
            50% { 
                background: rgba(52, 211, 153, 0.25);
                box-shadow: 0 0 15px 2px rgba(52, 211, 153, 0.4);
                border: 1px solid rgba(110, 231, 183, 0.6);
            }
            100% { 
                background: rgba(16, 185, 129, 0.05);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
                border: 1px solid rgba(16, 185, 129, 0.1);
            }
        }

        /* STILE LINK INDICE */
        .index-link { 
            position: absolute; 
            cursor: pointer; 
            z-index: 1000; 
            border-radius: 8px;
            animation: aiPulse 3s infinite ease-in-out;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* EFFETTO HOVER: VETRO LUMINOSO VERDE */
        .index-link:hover {
            animation: none;
            background: rgba(209, 250, 229, 0.4);
            border: 1px solid rgba(52, 211, 153, 1);
            box-shadow: 0 0 30px rgba(52, 211, 153, 0.8);
            transform: scale(1.04);
            z-index: 1001;
        }
        
        .video-home-btn {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 18px; backdrop-filter: blur(5px);
            transition: 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .video-home-btn:hover { background: rgba(255,255,255,0.9); color: #b30000; transform: scale(1.1); }

        .page::after { content: ""; position: absolute; top: 0; width: 50px; height: 100%; z-index: 5; pointer-events: none; }
        .page:nth-child(even)::after { right: 0; background: linear-gradient(to left, rgba(0,0,0,0.15), transparent); }
        .page:nth-child(odd)::after { left: 0; background: linear-gradient(to right, rgba(0,0,0,0.15), transparent); }
    </style>
</head>
<body onkeydown="return (event.keyCode != 123 && !event.ctrlKey && !event.shiftKey)">

    <div id="zoom-wrapper">
        <div id="flipbook"></div>
    </div>

    <script>
        (function() {
            const totalPages = 24; 
            
            const map = [
                { t: 20, l: 5,  w: 40, h: 8, p: 4 },  { t: 30, l: 5,  w: 40, h: 12, p: 5 }, 
                { t: 45, l: 5,  w: 40, h: 8, p: 6 },  { t: 58, l: 5,  w: 40, h: 8, p: 8 },  
                { t: 70, l: 5,  w: 40, h: 8, p: 10 }, { t: 82, l: 5,  w: 40, h: 8, p: 11 }, 
                { t: 20, l: 50, w: 40, h: 8, p: 12 }, { t: 30, l: 50, w: 40, h: 8, p: 13 }, 
                { t: 45, l: 50, w: 40, h: 8, p: 16 }, { t: 58, l: 50, w: 40, h: 8, p: 19 }, 
                { t: 70, l: 50, w: 40, h: 10, p: 21 },{ t: 82, l: 50, w: 40, h: 8, p: 22 }
            ];

            // FUNZIONE ASINCRONA PER RENDERIZZARE I PDF
            async function renderPage(pageNum, container) {
                try {
                    const url = pageNum + '.pdf';
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    
                    // Scale 2.0 per alta definizione (retina ready)
                    const viewport = page.getViewport({ scale: 2.0 }); 
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Aggiunge il canvas al contenitore
                    container.appendChild(canvas);
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                    
                } catch (error) {
                    console.error('Errore caricamento PDF pagina ' + pageNum, error);
                    container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:red;">Errore PDF</div>';
                }
            }

            $(document).ready(function() {
                const fb = $('#flipbook');

                for (let i = 1; i <= totalPages; i++) {
                    const pg = $('<div class="page" id="page-' + i + '"></div>');

                    // GESTIONE CONTENUTI PAGINE
                    if (i === 23) {
                        // PAGINA VIDEO (Rimane invariata)
                        const vid = $(`
                            <video class="magazine-video" playsinline webkit-playsinline>
                                <source src="23.mp4" type="video/mp4">
                            </video>
                            <div class="video-home-btn" data-target="3" title="Torna all'Indice">üè†</div>
                        `);
                        pg.append(vid);
                    } else {
                        // TUTTE LE ALTRE PAGINE (inclusa la 3): Carica il PDF
                        // Nota: Passiamo l'elemento DOM nativo [0] alla funzione di rendering
                        renderPage(i, pg[0]);
                    }

                    // GESTIONE INDICE (Pagina 3)
                    // I link vengono aggiunti SOPRA il PDF renderizzato
                    if (i === 3) {
                        map.forEach((l, index) => {
                            const delay = index * 0.3; 
                            const link = $('<div class="index-link"></div>').css({
                                top: l.t + '%', 
                                left: l.l + '%', 
                                width: l.w + '%', 
                                height: l.h + '%',
                                'animation-delay': delay + 's' 
                            }).attr('data-target', l.p);
                            pg.append(link);
                        });
                    }
                    
                    fb.append(pg);
                }

                $(document).on('click', '.index-link, .video-home-btn', function(e) {
                    e.preventDefault();
                    const targetPage = $(this).attr('data-target');
                    if (targetPage) fb.turn('page', targetPage);
                });

                fb.bind("turned", function(event, page, view) {
                    const video = document.querySelector('video');
                    if (video) {
                        if (view.indexOf(23) !== -1) {
                            video.currentTime = 0;
                            const playPromise = video.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(() => {
                                    video.muted = true; 
                                    video.play();
                                });
                            }
                        } else {
                            video.pause();
                        }
                    }
                });

                fb.turn({ width: 960, height: 680, autoCenter: true, duration: 1000, acceleration: true });

                function resize() {
                    const s = Math.min($(window).width() / 960, $(window).height() / 680) * 0.95;
                    $('#zoom-wrapper').css('transform', `scale(${s})`);
                }
                $(window).resize(resize); resize();
                setTimeout(() => fb.addClass('visible'), 300);

                setInterval(function() { (function() { return false; }).constructor("debugger")(); }, 200);
            });
        })();
    </script>
</body>
</html>