<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Il CamaLEOnte - Magazine Ufficiale</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>

    <style>
        /* BASE & RESET */
        * { -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
        body { background-color: #0f0f0f; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        
        #zoom-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #flipbook { opacity: 0; transition: opacity 1s; }
        #flipbook.visible { opacity: 1; }
        .page { background-color: white; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.6); overflow: hidden; }
        
        /* LAYERS */
        .layer-pdf { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .layer-interactive { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .layer-interactive * { pointer-events: auto; }

        .pdf-canvas { width: 100%; height: 100%; display: block; }
        .magazine-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 5; background: #000; }

        /* --- BOTTONI UI --- */
        .action-btn {
            position: fixed; top: 20px; z-index: 9999;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.6); color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 24px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .action-btn:hover { background: #10b981; transform: scale(1.1); color: white; border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        #mode-btn { left: 20px; }
        #home-btn { right: 20px; }

        /* --- LINK INDICE MAGICI (NUOVI) --- */
        /* 1. Il Respiro (Base) */
        @keyframes magicBreath {
            0%, 100% { 
                background: rgba(16, 185, 129, 0.05); 
                border-color: rgba(16, 185, 129, 0.2);
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.1);
            }
            50% { 
                background: rgba(16, 185, 129, 0.15); 
                border-color: rgba(16, 185, 129, 0.5);
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            }
        }

        /* 2. La Scia di Luce (Shimmer) */
        @keyframes magicShimmer {
            0% { transform: translateX(-150%) skewX(-20deg); }
            50% { transform: translateX(150%) skewX(-20deg); } /* Passa veloce */
            100% { transform: translateX(150%) skewX(-20deg); } /* Pausa lunga */
        }

        .index-link { 
            position: absolute; cursor: pointer; border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            overflow: hidden; /* Fondamentale per la scia */
            animation: magicBreath 4s infinite ease-in-out; 
        }

        /* Creiamo la luce che passa */
        .index-link::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.6), transparent);
            transform: translateX(-150%) skewX(-20deg);
            animation: magicShimmer 3s infinite; /* Ogni 3 secondi */
        }

        /* Hover: Esplosione di luce */
        .index-link:hover {
            animation: none; /* Ferma il respiro */
            background: rgba(16, 185, 129, 0.3); 
            border: 2px solid #34d399;
            box-shadow: 0 0 30px #10b981, inset 0 0 20px rgba(16, 185, 129, 0.5); 
            transform: scale(1.02);
            z-index: 20; /* Porta in primo piano */
        }
        /* Nascondi la scia durante l'hover per pulizia */
        .index-link:hover::after { display: none; }


        /* --- TUTORIAL OVERLAY --- */
        #tutorial-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.85); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            opacity: 0; pointer-events: none; transition: opacity 0.6s ease;
        }
        #tutorial-overlay.active { opacity: 1; pointer-events: auto; }
        
        .tutorial-container { max-width: 900px; width: 90%; text-align: center; }
        .welcome-title {
            font-size: 3rem; font-weight: 800; color: white; margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px;
        }
        .welcome-subtitle { color: #a1a1aa; font-size: 1.1rem; margin-bottom: 50px; }
        .tutorial-grid { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 50px; }
        .glass-card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px; border-radius: 20px; width: 160px;
            display: flex; flex-direction: column; align-items: center; transition: transform 0.3s;
        }
        .glass-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
        .anim-box { height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 40px; }
        .card-label { color: #fff; font-weight: bold; font-size: 1rem; margin-bottom: 5px; }
        .card-desc { color: #71717a; font-size: 0.8rem; line-height: 1.4; }

        @keyframes swipeHand {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-15px) rotate(-10deg); }
            75% { transform: translateX(15px) rotate(10deg); }
        }
        .anim-swipe { animation: swipeHand 2s infinite ease-in-out; display: inline-block; }
        @keyframes pinchZoom {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.3); opacity: 1; }
        }
        .anim-zoom { animation: pinchZoom 2s infinite ease-in-out; display: inline-block; }
        @keyframes pulseBtn {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .anim-menu { 
            width: 40px; height: 40px; border-radius: 50%; background: #10b981; 
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            animation: pulseBtn 2s infinite; 
        }
        .start-btn {
            background: #10b981; color: #000; font-weight: 700; font-size: 1.1rem;
            padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); transition: all 0.3s;
        }
        .start-btn:hover { transform: scale(1.05); background: #34d399; box-shadow: 0 0 30px rgba(16, 185, 129, 0.6); }

    </style>
</head>

<body oncontextmenu="return false;" onkeydown="return (event.keyCode != 123 && !event.ctrlKey && !event.shiftKey)">

    <div id="mode-btn" class="action-btn" title="Cambia Vista">üìñ</div>
    <div id="home-btn" class="action-btn" title="Torna all'Indice">üè†</div>

    <div id="tutorial-overlay">
        <div class="tutorial-container">
            <div class="welcome-title">Il CamaLEOnte</div>
            <div class="welcome-subtitle">Magazine Interattivo Aumentato</div>
            <div class="tutorial-grid">
                <div class="glass-card">
                    <div class="anim-box"><span class="anim-swipe">üëÜ</span></div>
                    <div class="card-label">Sfoglia</div>
                    <div class="card-desc">Trascina o clicca gli angoli</div>
                </div>
                <div class="glass-card">
                    <div class="anim-box"><span class="anim-zoom">üîç</span></div>
                    <div class="card-label">Zoom</div>
                    <div class="card-desc">Pizzica con due dita</div>
                </div>
                <div class="glass-card">
                    <div class="anim-box"><div class="anim-menu">üìñ</div></div>
                    <div class="card-label">Vista</div>
                    <div class="card-desc">Cambia modalit√† lettura</div>
                </div>
            </div>
            <button class="start-btn" id="close-tutorial">Entra nella Rivista</button>
        </div>
    </div>

    <div id="zoom-wrapper">
        <div id="flipbook"></div>
    </div>

    <script>
        (function() {
            let isMobile = window.innerWidth < 768;
            let isSingleMode = isMobile; 
            const totalPages = 24; 
            const pageRatio = 0.7058; 

            const map = [
                { t: 20, l: 5,  w: 40, h: 8, p: 4 },  { t: 30, l: 5,  w: 40, h: 12, p: 5 }, 
                { t: 45, l: 5,  w: 40, h: 8, p: 6 },  { t: 58, l: 5,  w: 40, h: 8, p: 8 },  
                { t: 70, l: 5,  w: 40, h: 8, p: 10 }, { t: 82, l: 5,  w: 40, h: 8, p: 11 }, 
                { t: 20, l: 50, w: 40, h: 8, p: 12 }, { t: 30, l: 50, w: 40, h: 8, p: 13 }, 
                { t: 45, l: 50, w: 40, h: 8, p: 16 }, { t: 58, l: 50, w: 40, h: 8, p: 19 }, 
                { t: 70, l: 50, w: 40, h: 10, p: 21 },{ t: 82, l: 50, w: 40, h: 8, p: 22 }
            ];

            async function renderPage(pageNum, container) {
                try {
                    const url = pageNum + '.pdf';
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 2.5 }); 
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    container.innerHTML = ''; 
                    container.appendChild(canvas);
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                } catch (e) { console.error(e); }
            }

            $(document).ready(function() {
                const fb = $('#flipbook');
                const wrapper = $('#zoom-wrapper');
                const modeBtn = $('#mode-btn');

                if (!localStorage.getItem('camaLeonteTutorialPro')) {
                    $('#tutorial-overlay').addClass('active');
                }

                $('#close-tutorial').click(function() {
                    $('#tutorial-overlay').css('opacity', '0');
                    setTimeout(() => { $('#tutorial-overlay').removeClass('active'); }, 600);
                    localStorage.setItem('camaLeonteTutorialPro', 'true');
                });

                for (let i = 1; i <= totalPages; i++) {
                    const pg = $('<div class="page" id="p' + i + '"></div>');
                    const pdfLayer = $('<div class="layer-pdf"></div>');
                    const interactiveLayer = $('<div class="layer-interactive"></div>');
                    pg.append(pdfLayer).append(interactiveLayer);

                    // VIDEO 22, 23, 24
                    if (i === 22 || i === 23 || i === 24) { 
                        const videoSrc = i + ".mp4"; 
                        pdfLayer.append(`<video class="magazine-video" playsinline webkit-playsinline loop muted><source src="${videoSrc}" type="video/mp4"></video>`);
                    } else {
                        renderPage(i, pdfLayer[0]);
                    }

                    if (i === 3) {
                        map.forEach((l) => {
                            const link = $('<div class="index-link"></div>').css({
                                top: l.t + '%', left: l.l + '%', width: l.w + '%', height: l.h + '%'
                            }).attr('data-target', l.p);
                            interactiveLayer.append(link);
                        });
                    }
                    fb.append(pg);
                }

                function checkAndPlayVideos(view) {
                    $('video').each(function() { this.pause(); });
                    view.forEach(pageNum => {
                        if (pageNum === 0) return;
                        const vid = $('#p' + pageNum).find('video')[0];
                        if (vid) {
                            vid.currentTime = 0; 
                            var playPromise = vid.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(error => { vid.muted = true; vid.play(); });
                            }
                        }
                    });
                }

                fb.bind("turned", function(event, page, view) { checkAndPlayVideos(view); });

                function updateLayout() {
                    modeBtn.text(isSingleMode ? 'üìÑ' : 'üìñ');
                    const availW = $(window).width() * 0.95; 
                    const availH = $(window).height() * 0.95;
                    let targetW, targetH;

                    if (isSingleMode) {
                        if (availW / availH > pageRatio) { targetH = availH; targetW = targetH * pageRatio; } 
                        else { targetW = availW; targetH = targetW / pageRatio; }
                        fb.turn('display', 'single'); fb.turn('size', targetW, targetH);
                    } else {
                        const doubleRatio = pageRatio * 2; 
                        if (availW / availH > doubleRatio) { targetH = availH; targetW = targetH * doubleRatio; } 
                        else { targetW = availW; targetH = targetW / doubleRatio; }
                        fb.turn('display', 'double'); fb.turn('size', targetW, targetH);
                    }
                    fb.css({ width: targetW, height: targetH });
                    const currentView = fb.turn('view');
                    checkAndPlayVideos(currentView);
                }

                fb.turn({
                    width: 1000, height: 600,
                    elevation: 50, duration: 1000, gradients: true, autoCenter: true,
                    display: isSingleMode ? 'single' : 'double'
                });

                $(window).resize(function() {
                    clearTimeout(window.resizedFinished);
                    window.resizedFinished = setTimeout(updateLayout, 100);
                });

                $('#mode-btn').click(function() { isSingleMode = !isSingleMode; updateLayout(); });
                $('#home-btn').click(function() { fb.turn('page', 3); });
                $(document).on('click', '.index-link', function() { fb.turn('page', $(this).attr('data-target')); });

                updateLayout();
                setTimeout(() => fb.addClass('visible'), 500);
            });
        })();
    </script>
</body>
</html>