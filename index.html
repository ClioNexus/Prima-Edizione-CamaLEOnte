<!DOCTYPE html>
<html lang="it" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Il CamaLEOnte - Magazine Ufficiale</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>

    <style>
        /* BASE & RESET */
        * { -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { background-color: #121212; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        
        /* WRAPPER CENTRALE: Niente pi√π dimensioni fisse o trasformazioni qui */
        #zoom-wrapper { 
            width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden;
        }

        #flipbook { opacity: 0; transition: opacity 1s; }
        #flipbook.visible { opacity: 1; }

        .page { background-color: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; }
        
        /* LAYERS */
        .layer-pdf { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .layer-interactive { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .layer-interactive * { pointer-events: auto; }

        .pdf-canvas { width: 100%; height: 100%; display: block; }

        /* VIDEO */
        .magazine-video { 
            width: 100%; height: 100%; object-fit: cover; 
            position: absolute; top: 0; left: 0; z-index: 5; background: #000; 
        }

        /* --- BOTTONI --- */
        .action-btn {
            position: fixed; top: 20px; z-index: 9999;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(30,30,30,0.8); color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 24px; border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .action-btn:hover { background: #10b981; transform: scale(1.1); color: white; }
        
        #mode-btn { left: 20px; }
        #home-btn { right: 20px; }

        /* --- LINK INDICE --- */
        @keyframes aiPulse {
            0% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
            50% { background: rgba(52, 211, 153, 0.3); box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); border: 1px solid rgba(110, 231, 183, 0.8); }
            100% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
        }

        .index-link { 
            position: absolute; cursor: pointer; border-radius: 8px;
            animation: aiPulse 3s infinite ease-in-out; 
        }
        .index-link:hover {
            animation: none; 
            background: rgba(209, 250, 229, 0.5); 
            border: 2px solid #10b981;
            box-shadow: 0 0 25px #10b981; 
            transform: scale(1.02);
        }
    </style>
</head>
<body>

    <div id="mode-btn" class="action-btn" title="Cambia Vista">üìñ</div>
    <div id="home-btn" class="action-btn" title="Torna all'Indice">üè†</div>

    <div id="zoom-wrapper">
        <div id="flipbook"></div>
    </div>

    <script>
        (function() {
            // Stato Iniziale
            let isMobile = window.innerWidth < 768;
            let isSingleMode = isMobile; 
            
            const totalPages = 24; 
            // Proporzione standard di UNA pagina A4 (Larghezza / Altezza)
            // 960x680 in doppia pagina significa 480x680 per pagina singola.
            // Ratio = 480 / 680 = 0.7058
            const pageRatio = 0.7058; 

            const map = [
                { t: 20, l: 5,  w: 40, h: 8, p: 4 },  { t: 30, l: 5,  w: 40, h: 12, p: 5 }, 
                { t: 45, l: 5,  w: 40, h: 8, p: 6 },  { t: 58, l: 5,  w: 40, h: 8, p: 8 },  
                { t: 70, l: 5,  w: 40, h: 8, p: 10 }, { t: 82, l: 5,  w: 40, h: 8, p: 11 }, 
                { t: 20, l: 50, w: 40, h: 8, p: 12 }, { t: 30, l: 50, w: 40, h: 8, p: 13 }, 
                { t: 45, l: 50, w: 40, h: 8, p: 16 }, { t: 58, l: 50, w: 40, h: 8, p: 19 }, 
                { t: 70, l: 50, w: 40, h: 10, p: 21 },{ t: 82, l: 50, w: 40, h: 8, p: 22 }
            ];

            // RENDER PDF
            async function renderPage(pageNum, container) {
                try {
                    const url = pageNum + '.pdf';
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    
                    const viewport = page.getViewport({ scale: 2.5 }); 
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    container.innerHTML = ''; 
                    container.appendChild(canvas);
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                } catch (e) { console.error(e); }
            }

            $(document).ready(function() {
                const fb = $('#flipbook');
                const wrapper = $('#zoom-wrapper');
                const modeBtn = $('#mode-btn');

                // 1. CREAZIONE PAGINE
                for (let i = 1; i <= totalPages; i++) {
                    const pg = $('<div class="page"></div>');
                    const pdfLayer = $('<div class="layer-pdf"></div>');
                    const interactiveLayer = $('<div class="layer-interactive"></div>');

                    pg.append(pdfLayer).append(interactiveLayer);

                    if (i === 23) {
                        pdfLayer.append(`<video class="magazine-video" playsinline webkit-playsinline><source src="23.mp4" type="video/mp4"></video>`);
                    } else {
                        renderPage(i, pdfLayer[0]);
                    }

                    if (i === 3) {
                        map.forEach((l) => {
                            const link = $('<div class="index-link"></div>').css({
                                top: l.t + '%', left: l.l + '%', width: l.w + '%', height: l.h + '%'
                            }).attr('data-target', l.p);
                            interactiveLayer.append(link);
                        });
                    }
                    fb.append(pg);
                }

                // 2. MOTORE DI RIDIMENSIONAMENTO MATEMATICO (CORE FIX)
                function updateLayout() {
                    modeBtn.text(isSingleMode ? 'üìÑ' : 'üìñ');
                    
                    // Dimensioni disponibili nella finestra (meno margini)
                    const availW = $(window).width() * 0.95; 
                    const availH = $(window).height() * 0.95;
                    
                    let targetW, targetH;

                    if (isSingleMode) {
                        // CALCOLO MODALIT√Ä SINGOLA
                        // La pagina deve stare nello schermo mantenendo ratio
                        if (availW / availH > pageRatio) {
                            // Schermo pi√π largo della pagina: Vincola l'altezza
                            targetH = availH;
                            targetW = targetH * pageRatio;
                        } else {
                            // Schermo pi√π stretto della pagina: Vincola la larghezza
                            targetW = availW;
                            targetH = targetW / pageRatio;
                        }
                        
                        fb.turn('display', 'single');
                        // Forza dimensioni esplicite
                        fb.turn('size', targetW, targetH);
                        
                    } else {
                        // CALCOLO MODALIT√Ä DOPPIA (RIVISTA APERTA)
                        // Ratio doppia pagina = pageRatio * 2 = 1.41
                        const doubleRatio = pageRatio * 2; 

                        if (availW / availH > doubleRatio) {
                            // Schermo molto largo: Vincola altezza
                            targetH = availH;
                            targetW = targetH * doubleRatio;
                        } else {
                            // Schermo stretto: Vincola larghezza
                            targetW = availW;
                            targetH = targetW / doubleRatio;
                        }

                        fb.turn('display', 'double');
                        // Forza dimensioni esplicite
                        fb.turn('size', targetW, targetH);
                    }
                    
                    // Centra il flipbook nel wrapper (che √® flexbox)
                    fb.css({ width: targetW, height: targetH });
                }

                // 3. AVVIO TURN.JS
                // Inizializziamo con dimensioni dummy, tanto updateLayout corregge subito
                fb.turn({
                    width: 1000, height: 600,
                    elevation: 50,
                    duration: 1000,
                    gradients: true,
                    autoCenter: true,
                    display: isSingleMode ? 'single' : 'double'
                });

                // 4. EVENTI
                $(window).resize(function() {
                    clearTimeout(window.resizedFinished);
                    window.resizedFinished = setTimeout(updateLayout, 100);
                });

                $('#mode-btn').click(function() {
                    isSingleMode = !isSingleMode;
                    updateLayout();
                });

                $('#home-btn').click(function() { fb.turn('page', 3); });

                $(document).on('click', '.index-link', function() {
                    fb.turn('page', $(this).attr('data-target'));
                });

                // Avvio layout
                updateLayout();
                setTimeout(() => fb.addClass('visible'), 500);
            });
        })();
    </script>
</body>
</html>