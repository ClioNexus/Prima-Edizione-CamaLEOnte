<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Il CamaLEOnte - Magazine Ufficiale</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="turn.min.js"></script>

    <style>
        /* BASE & RESET */
        * { -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { background-color: #121212; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; font-family: 'Montserrat', sans-serif; }
        
        #zoom-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #flipbook { opacity: 0; transition: opacity 1s; }
        #flipbook.visible { opacity: 1; }
        .page { background-color: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; }
        
        /* LAYERS (Architettura Sicura) */
        .layer-pdf { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .layer-interactive { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .layer-interactive * { pointer-events: auto; }

        .pdf-canvas { width: 100%; height: 100%; display: block; }
        .magazine-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 5; background: #000; }

        /* --- BOTTONI UI --- */
        .action-btn {
            position: fixed; top: 20px; z-index: 9999;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(30,30,30,0.9); color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 24px; border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .action-btn:hover { background: #10b981; transform: scale(1.1); color: white; border-color: #10b981; }
        #mode-btn { left: 20px; }
        #home-btn { right: 20px; }

        /* --- LINK INDICE --- */
        @keyframes aiPulse {
            0% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
            50% { background: rgba(52, 211, 153, 0.3); box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); border: 1px solid rgba(110, 231, 183, 0.8); }
            100% { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
        }
        .index-link { position: absolute; cursor: pointer; border-radius: 8px; animation: aiPulse 3s infinite ease-in-out; }
        .index-link:hover { animation: none; background: rgba(209, 250, 229, 0.5); border: 2px solid #10b981; box-shadow: 0 0 25px #10b981; transform: scale(1.02); }

        /* --- TUTORIAL OVERLAY --- */
        #tutorial-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; backdrop-filter: blur(5px);
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #tutorial-overlay.active { opacity: 1; pointer-events: auto; }
        
        .tutorial-card {
            background: #1e1e1e; padding: 30px; border-radius: 20px; max-width: 80%; width: 300px;
            border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .tutorial-icon { font-size: 40px; margin-bottom: 15px; }
        .tutorial-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; color: #10b981; }
        .tutorial-text { font-size: 14px; color: #ccc; margin-bottom: 20px; line-height: 1.5; }
        .tutorial-btn {
            background: #10b981; color: #121212; font-weight: bold; padding: 12px 25px;
            border-radius: 30px; border: none; cursor: pointer; font-size: 16px; transition: 0.2s;
        }
        .tutorial-btn:hover { transform: scale(1.05); background: #34d399; }
        .tutorial-arrow { position: absolute; font-size: 30px; color: #10b981; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

    </style>
</head>

<body oncontextmenu="return false;" onkeydown="return (event.keyCode != 123 && !event.ctrlKey && !event.shiftKey)">

    <div id="mode-btn" class="action-btn" title="Cambia Vista">üìñ</div>
    <div id="home-btn" class="action-btn" title="Torna all'Indice">üè†</div>

    <div id="tutorial-overlay">
        <div style="position:absolute; top: 80px; left: 20px;" class="tutorial-arrow">‚Üñ</div>
        <div class="tutorial-card">
            <div class="tutorial-icon">üëã</div>
            <div class="tutorial-title">Benvenuto!</div>
            <div class="tutorial-text">
                <p><strong>üìñ Vista:</strong> Usa il bottone in alto a sinistra per cambiare tra pagina singola e doppia.</p>
                <p><strong>ü§è Zoom:</strong> Usa due dita per ingrandire i testi.</p>
                <p><strong>üè† Home:</strong> Torna all'indice quando vuoi.</p>
            </div>
            <button class="tutorial-btn" id="close-tutorial">Ho capito, iniziamo!</button>
        </div>
    </div>

    <div id="zoom-wrapper">
        <div id="flipbook"></div>
    </div>

    <script>
        (function() {
            let isMobile = window.innerWidth < 768;
            let isSingleMode = isMobile; 
            const totalPages = 24; 
            const pageRatio = 0.7058; 

            const map = [
                { t: 20, l: 5,  w: 40, h: 8, p: 4 },  { t: 30, l: 5,  w: 40, h: 12, p: 5 }, 
                { t: 45, l: 5,  w: 40, h: 8, p: 6 },  { t: 58, l: 5,  w: 40, h: 8, p: 8 },  
                { t: 70, l: 5,  w: 40, h: 8, p: 10 }, { t: 82, l: 5,  w: 40, h: 8, p: 11 }, 
                { t: 20, l: 50, w: 40, h: 8, p: 12 }, { t: 30, l: 50, w: 40, h: 8, p: 13 }, 
                { t: 45, l: 50, w: 40, h: 8, p: 16 }, { t: 58, l: 50, w: 40, h: 8, p: 19 }, 
                { t: 70, l: 50, w: 40, h: 10, p: 21 },{ t: 82, l: 50, w: 40, h: 8, p: 22 }
            ];

            async function renderPage(pageNum, container) {
                try {
                    const url = pageNum + '.pdf';
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 2.5 }); 
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    container.innerHTML = ''; 
                    container.appendChild(canvas);
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                } catch (e) { console.error(e); }
            }

            $(document).ready(function() {
                const fb = $('#flipbook');
                const wrapper = $('#zoom-wrapper');
                const modeBtn = $('#mode-btn');

                if (!localStorage.getItem('camaLeonteTutorialV1')) {
                    $('#tutorial-overlay').addClass('active');
                }
                $('#close-tutorial').click(function() {
                    $('#tutorial-overlay').removeClass('active');
                    localStorage.setItem('camaLeonteTutorialV1', 'true');
                });

                for (let i = 1; i <= totalPages; i++) {
                    const pg = $('<div class="page" id="p' + i + '"></div>');
                    const pdfLayer = $('<div class="layer-pdf"></div>');
                    const interactiveLayer = $('<div class="layer-interactive"></div>');
                    pg.append(pdfLayer).append(interactiveLayer);

                    // --- QUI C'√à IL FIX FONDAMENTALE (22 e 23) ---
                    if (i === 22 || i === 23) {
                        const videoSrc = i + ".mp4"; 
                        // Muted inserito qui per sicurezza
                        pdfLayer.append(`<video class="magazine-video" playsinline webkit-playsinline loop muted><source src="${videoSrc}" type="video/mp4"></video>`);
                    } else {
                        renderPage(i, pdfLayer[0]);
                    }

                    if (i === 3) {
                        map.forEach((l) => {
                            const link = $('<div class="index-link"></div>').css({
                                top: l.t + '%', left: l.l + '%', width: l.w + '%', height: l.h + '%'
                            }).attr('data-target', l.p);
                            interactiveLayer.append(link);
                        });
                    }
                    fb.append(pg);
                }

                // GESTORE VIDEO AGGIORNATO
                function checkAndPlayVideos(view) {
                    $('video').each(function() { this.pause(); });
                    view.forEach(pageNum => {
                        if (pageNum === 0) return;
                        const vid = $('#p' + pageNum).find('video')[0];
                        if (vid) {
                            vid.currentTime = 0; 
                            var playPromise = vid.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(error => {
                                    vid.muted = true; 
                                    vid.play(); 
                                });
                            }
                        }
                    });
                }

                fb.bind("turned", function(event, page, view) {
                    checkAndPlayVideos(view);
                });

                function updateLayout() {
                    modeBtn.text(isSingleMode ? 'üìÑ' : 'üìñ');
                    const availW = $(window).width() * 0.95; 
                    const availH = $(window).height() * 0.95;
                    let targetW, targetH;

                    if (isSingleMode) {
                        if (availW / availH > pageRatio) {
                            targetH = availH; targetW = targetH * pageRatio;
                        } else {
                            targetW = availW; targetH = targetW / pageRatio;
                        }
                        fb.turn('display', 'single');
                        fb.turn('size', targetW, targetH);
                    } else {
                        const doubleRatio = pageRatio * 2; 
                        if (availW / availH > doubleRatio) {
                            targetH = availH; targetW = targetH * doubleRatio;
                        } else {
                            targetW = availW; targetH = targetW / doubleRatio;
                        }
                        fb.turn('display', 'double');
                        fb.turn('size', targetW, targetH);
                    }
                    fb.css({ width: targetW, height: targetH });
                    
                    const currentView = fb.turn('view');
                    checkAndPlayVideos(currentView);
                }

                fb.turn({
                    width: 1000, height: 600,
                    elevation: 50, duration: 1000, gradients: true, autoCenter: true,
                    display: isSingleMode ? 'single' : 'double'
                });

                $(window).resize(function() {
                    clearTimeout(window.resizedFinished);
                    window.resizedFinished = setTimeout(updateLayout, 100);
                });

                $('#mode-btn').click(function() { isSingleMode = !isSingleMode; updateLayout(); });
                $('#home-btn').click(function() { fb.turn('page', 3); });
                $(document).on('click', '.index-link', function() { fb.turn('page', $(this).attr('data-target')); });

                updateLayout();
                setTimeout(() => fb.addClass('visible'), 500);
            });
        })();
    </script>
</body>
</html>